const fs = require('fs'),
    javaStringSplitter = require('../java/java-string-splitter'),
    path = require('path'),
    webpack = require("webpack");

const OUT_JS = path.join(__dirname, '..', 'out', 'bundle.js');
const OUT_JAVA = path.join(__dirname, '..', 'out',
    'NashornVueTemplateCompiler.java');

module.exports = function () {
  webpack({
    entry: './nashorn-template-compiler.js',
    output: {
      filename: path.join('.', 'out', 'bundle.js')
    },
    plugins: [
      new webpack.optimize.UglifyJsPlugin({
        compress: {
          warnings: false,
          drop_console: false,
        }
      })
    ],
    target: 'node'
  }, (err, stats) => {
    if (err) {
      console.error(err);
    }

    fs.readFile(OUT_JS, 'utf8', function (err, data) {
      if (err) {
        throw err;
      }

      const javaStringBuilder = javaStringSplitter.splitStringForJava(data,
          'NASHORN_VUE_TEMPLATE_COMPILER');
      fs.writeFile(OUT_JAVA, `package com.axellience.vuegwt.processors.template;

/**
This class is generated by utils/nashorn/process-nashorn-template-compiler.js
*/
class NashornVueTemplateCompiler
{
    public static String NASHORN_VUE_TEMPLATE_COMPILER;

    static
    {
    	${javaStringBuilder}
    }
}`, () => console.log('Process Nashorn Template Compiler SUCCESS'));
    });
  });
};
